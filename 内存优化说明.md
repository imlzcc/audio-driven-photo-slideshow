# 内存优化说明

## 问题描述
程序在处理大量视频片段时出现内存使用率过高（97%+），导致所有视频片段都被跳过，无法正常处理。

## 优化策略

### 1. 动态批次大小调整
- **内存使用率 > 95%**：批次大小 = 1（一次只处理1个视频片段）
- **内存使用率 > 90%**：批次大小 = 2（一次处理2个视频片段）
- **内存使用率 > 80%**：批次大小 = 2（一次处理2个视频片段）
- **正常情况**：根据视频片段总数动态调整（2-5个）

### 2. 内存阈值调整
- **跳过阈值**：从85%提升到95%
- **警告阈值**：从75%提升到90%
- 允许在更高内存使用率下继续处理

### 3. 积极内存清理
- 每批处理完成后强制垃圾回收
- 内存使用率 > 85%时进行深度清理
- 主动关闭已处理的视频片段对象

### 4. 实时内存监控
- 每个批次开始前检查内存使用率
- 动态调整批次大小
- 显示当前内存使用率

### 5. 用户提示
- 在UI中添加内存使用提示
- 内存不足时给出建议
- 显示当前内存使用率

## 优化效果

### 预期改进
1. **降低跳过率**：从100%降低到可接受水平
2. **提高处理效率**：在内存允许范围内最大化批次大小
3. **增强稳定性**：避免内存溢出崩溃
4. **改善用户体验**：提供清晰的内存状态反馈

### 使用建议
1. **关闭其他程序**：处理大量视频片段时关闭不必要的程序
2. **减少视频片段数量**：如果内存仍然不足，可以减少插入的视频片段数量
3. **监控内存使用**：注意程序运行时的内存使用率提示

## 技术细节

### 内存检查频率
- 每个批次开始前检查
- 每个视频片段加载前检查
- 每批处理完成后检查

### 清理策略
- 自动垃圾回收（gc.collect()）
- 主动关闭视频对象（clip.close()）
- 深度清理（内存使用率 > 85%时）

### 动态调整
- 根据当前内存使用率实时调整批次大小
- 根据系统内存情况智能选择处理策略
- 提供降级处理方案

## 注意事项

1. **内存使用率显示**：程序会实时显示当前内存使用率
2. **批次大小变化**：批次大小会根据内存情况动态调整
3. **处理时间**：内存优化可能会略微增加处理时间
4. **系统要求**：建议在内存充足的环境下运行

## 故障排除

如果仍然出现内存不足：
1. 检查系统可用内存
2. 关闭其他占用内存的程序
3. 减少视频片段数量
4. 检查视频文件大小和分辨率
